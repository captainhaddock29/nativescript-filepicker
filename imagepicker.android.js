"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var application = require("tns-core-modules/application");
var imageAssetModule = require("tns-core-modules/image-asset");
var permissions = require("nativescript-permissions");
var UriHelper = (function () {
    function UriHelper() {
    }
    UriHelper._calculateFileUri = function (uri) {
        var DocumentsContract = android.provider.DocumentsContract;
        var isKitKat = android.os.Build.VERSION.SDK_INT >= 19;
        if (isKitKat && DocumentsContract.isDocumentUri(application.android.context, uri)) {
            var docId = void 0, id = void 0, type = void 0;
            var contentUri = null;
            if (UriHelper.isExternalStorageDocument(uri)) {
                docId = DocumentsContract.getDocumentId(uri);
                id = docId.split(":")[1];
                type = docId.split(":")[0];
                if ("primary" === type.toLowerCase()) {
                    return android.os.Environment.getExternalStorageDirectory() + "/" + id;
                }
            }
            else if (UriHelper.isDownloadsDocument(uri)) {
                id = DocumentsContract.getDocumentId(uri);
                contentUri = android.content.ContentUris.withAppendedId(android.net.Uri.parse("content://downloads/public_downloads"), long(id));
                return UriHelper.getDataColumn(contentUri, null, null);
            }
            else if (UriHelper.isMediaDocument(uri)) {
                docId = DocumentsContract.getDocumentId(uri);
                var split = docId.split(":");
                type = split[0];
                id = split[1];
                if ("image" === type) {
                    contentUri = android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI;
                }
                else if ("video" === type) {
                    contentUri = android.provider.MediaStore.Video.Media.EXTERNAL_CONTENT_URI;
                }
                else if ("audio" === type) {
                    contentUri = android.provider.MediaStore.Audio.Media.EXTERNAL_CONTENT_URI;
                }
                var selection = "_id=?";
                var selectionArgs = [id];
                return UriHelper.getDataColumn(contentUri, selection, selectionArgs);
            }
        }
        else {
            if ("content" === uri.getScheme()) {
                return UriHelper.getDataColumn(uri, null, null);
            }
            else if ("file" === uri.getScheme()) {
                return uri.getPath();
            }
        }
        return undefined;
    };
    UriHelper.getDataColumn = function (uri, selection, selectionArgs) {
        var cursor = null;
        var columns = [android.provider.MediaStore.MediaColumns.DATA];
        var filePath;
        try {
            cursor = this.getContentResolver().query(uri, columns, selection, selectionArgs, null);
            if (cursor != null && cursor.moveToFirst()) {
                var column_index = cursor.getColumnIndexOrThrow(columns[0]);
                filePath = cursor.getString(column_index);
                if (filePath) {
                    return filePath;
                }
            }
        }
        catch (e) {
            console.log(e);
        }
        finally {
            if (cursor) {
                cursor.close();
            }
        }
        return undefined;
    };
    UriHelper.isExternalStorageDocument = function (uri) {
        return "com.android.externalstorage.documents" === uri.getAuthority();
    };
    UriHelper.isDownloadsDocument = function (uri) {
        return "com.android.providers.downloads.documents" === uri.getAuthority();
    };
    UriHelper.isMediaDocument = function (uri) {
        return "com.android.providers.media.documents" === uri.getAuthority();
    };
    UriHelper.getContentResolver = function () {
        return application.android.nativeApp.getContentResolver();
    };
    return UriHelper;
}());
var ImagePicker = (function () {
    function ImagePicker(options) {
        this._options = options;
    }
    Object.defineProperty(ImagePicker.prototype, "mode", {
        get: function () {
            return this._options && this._options.mode && this._options.mode.toLowerCase() === 'single' ? 'single' : 'multiple';
        },
        enumerable: true,
        configurable: true
    });
    ImagePicker.prototype.authorize = function () {
        if (android.os.Build.VERSION.SDK_INT >= 23) {
            return permissions.requestPermission([android.Manifest.permission.READ_EXTERNAL_STORAGE]);
        }
        else {
            return Promise.resolve();
        }
    };
    ImagePicker.prototype.present = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var RESULT_CODE_PICKER_IMAGES = 1;
            var application = require("application");
            application.android.on(application.AndroidApplication.activityResultEvent, onResult);
            function onResult(args) {
                var requestCode = args.requestCode;
                var resultCode = args.resultCode;
                var data = args.intent;
                if (resultCode === android.app.Activity.RESULT_OK) {
                    try {
                        var results = [];
                        var clip = data.getClipData();
                        if (clip) {
                            var count = clip.getItemCount();
                            for (var i = 0; i < count; i++) {
                                var clipItem = clip.getItemAt(i);
                                if (clipItem) {
                                    var uri = clipItem.getUri();
                                    if (uri) {
                                        var selectedAsset = new imageAssetModule.ImageAsset(UriHelper._calculateFileUri(uri));
                                        results.push(selectedAsset);
                                    }
                                }
                            }
                        }
                        else {
                            var uri = data.getData();
                            var res = UriHelper._calculateFileUri(uri);
                            var selectedAsset = new imageAssetModule.ImageAsset(res);
                            var re = /(?:\.([^.]+))?$/;
                            var ext = re.exec(res)[1];
                            var listExtensions = ["pdf", "doc", "docx", "odt", "rtf", "jpg", "jpeg", "png"];
                            if (ext !== undefined && (listExtensions.indexOf(ext) > -1)) {
                                results.push(selectedAsset);
                            }
                        }
                        application.android.off(application.AndroidApplication.activityResultEvent, onResult);
                        resolve(results);
                        return;
                    }
                    catch (e) {
                        application.android.off(application.AndroidApplication.activityResultEvent, onResult);
                        reject(e);
                        return;
                    }
                }
                else {
                    application.android.off(application.AndroidApplication.activityResultEvent, onResult);
                    reject(new Error("Image picker activity result code " + resultCode));
                    return;
                }
            }
            var Intent = android.content.Intent;
            var intent = new Intent();
            intent.setType("*/*");
            if (_this.mode === 'multiple') {
                intent.putExtra("android.intent.extra.ALLOW_MULTIPLE", true);
            }
            intent.setAction(Intent.ACTION_GET_CONTENT);
            var chooser = Intent.createChooser(intent, "Select Picture");
            application.android.foregroundActivity.startActivityForResult(intent, RESULT_CODE_PICKER_IMAGES);
        });
    };
    return ImagePicker;
}());
exports.ImagePicker = ImagePicker;
function create(options) {
    return new ImagePicker(options);
}
exports.create = create;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2VwaWNrZXIuYW5kcm9pZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImltYWdlcGlja2VyLmFuZHJvaWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwwREFBNEQ7QUFDNUQsK0RBQWlFO0FBQ2pFLHNEQUF3RDtBQUV4RDtJQUFBO0lBMEdBLENBQUM7SUF6R2lCLDJCQUFpQixHQUEvQixVQUFnQyxHQUFvQjtRQUNoRCxJQUFJLGlCQUFpQixHQUFTLE9BQU8sQ0FBQyxRQUFTLENBQUMsaUJBQWlCLENBQUM7UUFDbEUsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFFdEQsRUFBRSxDQUFDLENBQUMsUUFBUSxJQUFJLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEYsSUFBSSxLQUFLLFNBQUEsRUFBRSxFQUFFLFNBQUEsRUFBRSxJQUFJLFNBQUEsQ0FBQztZQUNwQixJQUFJLFVBQVUsR0FBb0IsSUFBSSxDQUFDO1lBR3ZDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNDLEtBQUssR0FBRyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFM0IsRUFBRSxDQUFDLENBQUMsU0FBUyxLQUFLLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ25DLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFB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QUFDO0FBRkQsd0JBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhcHBsaWNhdGlvbiBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9hcHBsaWNhdGlvblwiO1xuaW1wb3J0ICogYXMgaW1hZ2VBc3NldE1vZHVsZSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9pbWFnZS1hc3NldFwiO1xuaW1wb3J0ICogYXMgcGVybWlzc2lvbnMgZnJvbSBcIm5hdGl2ZXNjcmlwdC1wZXJtaXNzaW9uc1wiO1xuXG5jbGFzcyBVcmlIZWxwZXIge1xuICAgIHB1YmxpYyBzdGF0aWMgX2NhbGN1bGF0ZUZpbGVVcmkodXJpOiBhbmRyb2lkLm5ldC5VcmkpIHtcbiAgICAgICAgbGV0IERvY3VtZW50c0NvbnRyYWN0ID0gKDxhbnk+YW5kcm9pZC5wcm92aWRlcikuRG9jdW1lbnRzQ29udHJhY3Q7XG4gICAgICAgIGxldCBpc0tpdEthdCA9IGFuZHJvaWQub3MuQnVpbGQuVkVSU0lPTi5TREtfSU5UID49IDE5OyAvLyBhbmRyb2lkLm9zLkJ1aWxkLlZFUlNJT05fQ09ERVMuS0lUS0FUXG5cbiAgICAgICAgaWYgKGlzS2l0S2F0ICYmIERvY3VtZW50c0NvbnRyYWN0LmlzRG9jdW1lbnRVcmkoYXBwbGljYXRpb24uYW5kcm9pZC5jb250ZXh0LCB1cmkpKSB7XG4gICAgICAgICAgICBsZXQgZG9jSWQsIGlkLCB0eXBlO1xuICAgICAgICAgICAgbGV0IGNvbnRlbnRVcmk6IGFuZHJvaWQubmV0LlVyaSA9IG51bGw7XG5cbiAgICAgICAgICAgIC8vIEV4dGVybmFsU3RvcmFnZVByb3ZpZGVyXG4gICAgICAgICAgICBpZiAoVXJpSGVscGVyLmlzRXh0ZXJuYWxTdG9yYWdlRG9jdW1lbnQodXJpKSkge1xuICAgICAgICAgICAgICAgIGRvY0lkID0gRG9jdW1lbnRzQ29udHJhY3QuZ2V0RG9jdW1lbnRJZCh1cmkpO1xuICAgICAgICAgICAgICAgIGlkID0gZG9jSWQuc3BsaXQoXCI6XCIpWzFdO1xuICAgICAgICAgICAgICAgIHR5cGUgPSBkb2NJZC5zcGxpdChcIjpcIilbMF07XG5cbiAgICAgICAgICAgICAgICBpZiAoXCJwcmltYXJ5XCIgPT09IHR5cGUudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5kcm9pZC5vcy5FbnZpcm9ubWVudC5nZXRFeHRlcm5hbFN0b3JhZ2VEaXJlY3RvcnkoKSArIFwiL1wiICsgaWQ7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gVE9ETyBoYW5kbGUgbm9uLXByaW1hcnkgdm9sdW1lc1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRG93bmxvYWRzUHJvdmlkZXJcbiAgICAgICAgICAgIGVsc2UgaWYgKFVyaUhlbHBlci5pc0Rvd25sb2Fkc0RvY3VtZW50KHVyaSkpIHtcbiAgICAgICAgICAgICAgICBpZCA9IERvY3VtZW50c0NvbnRyYWN0LmdldERvY3VtZW50SWQodXJpKTtcbiAgICAgICAgICAgICAgICBjb250ZW50VXJpID0gYW5kcm9pZC5jb250ZW50LkNvbnRlbnRVcmlzLndpdGhBcHBlbmRlZElkKFxuICAgICAgICAgICAgICAgICAgICBhbmRyb2lkLm5ldC5VcmkucGFyc2UoXCJjb250ZW50Oi8vZG93bmxvYWRzL3B1YmxpY19kb3dubG9hZHNcIiksIGxvbmcoaWQpKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBVcmlIZWxwZXIuZ2V0RGF0YUNvbHVtbihjb250ZW50VXJpLCBudWxsLCBudWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIE1lZGlhUHJvdmlkZXJcbiAgICAgICAgICAgIGVsc2UgaWYgKFVyaUhlbHBlci5pc01lZGlhRG9jdW1lbnQodXJpKSkge1xuICAgICAgICAgICAgICAgIGRvY0lkID0gRG9jdW1lbnRzQ29udHJhY3QuZ2V0RG9jdW1lbnRJZCh1cmkpO1xuICAgICAgICAgICAgICAgIGxldCBzcGxpdCA9IGRvY0lkLnNwbGl0KFwiOlwiKTtcbiAgICAgICAgICAgICAgICB0eXBlID0gc3BsaXRbMF07XG4gICAgICAgICAgICAgICAgaWQgPSBzcGxpdFsxXTtcblxuICAgICAgICAgICAgICAgIGlmIChcImltYWdlXCIgPT09IHR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFVyaSA9IGFuZHJvaWQucHJvdmlkZXIuTWVkaWFTdG9yZS5JbWFnZXMuTWVkaWEuRVhURVJOQUxfQ09OVEVOVF9VUkk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcInZpZGVvXCIgPT09IHR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFVyaSA9IGFuZHJvaWQucHJvdmlkZXIuTWVkaWFTdG9yZS5WaWRlby5NZWRpYS5FWFRFUk5BTF9DT05URU5UX1VSSTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFwiYXVkaW9cIiA9PT0gdHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50VXJpID0gYW5kcm9pZC5wcm92aWRlci5NZWRpYVN0b3JlLkF1ZGlvLk1lZGlhLkVYVEVSTkFMX0NPTlRFTlRfVVJJO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBzZWxlY3Rpb24gPSBcIl9pZD0/XCI7XG4gICAgICAgICAgICAgICAgbGV0IHNlbGVjdGlvbkFyZ3MgPSBbaWRdO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIFVyaUhlbHBlci5nZXREYXRhQ29sdW1uKGNvbnRlbnRVcmksIHNlbGVjdGlvbiwgc2VsZWN0aW9uQXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBNZWRpYVN0b3JlIChhbmQgZ2VuZXJhbClcbiAgICAgICAgICAgIGlmIChcImNvbnRlbnRcIiA9PT0gdXJpLmdldFNjaGVtZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFVyaUhlbHBlci5nZXREYXRhQ29sdW1uKHVyaSwgbnVsbCwgbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBGSUxFXG4gICAgICAgICAgICBlbHNlIGlmIChcImZpbGVcIiA9PT0gdXJpLmdldFNjaGVtZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVyaS5nZXRQYXRoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldERhdGFDb2x1bW4odXJpOiBhbmRyb2lkLm5ldC5VcmksIHNlbGVjdGlvbiwgc2VsZWN0aW9uQXJncykge1xuICAgICAgICBsZXQgY3Vyc29yID0gbnVsbDtcbiAgICAgICAgbGV0IGNvbHVtbnMgPSBbYW5kcm9pZC5wcm92aWRlci5NZWRpYVN0b3JlLk1lZGlhQ29sdW1ucy5EQVRBXTtcbiAgICAgICAgbGV0IGZpbGVQYXRoO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjdXJzb3IgPSB0aGlzLmdldENvbnRlbnRSZXNvbHZlcigpLnF1ZXJ5KHVyaSwgY29sdW1ucywgc2VsZWN0aW9uLCBzZWxlY3Rpb25BcmdzLCBudWxsKTtcbiAgICAgICAgICAgIGlmIChjdXJzb3IgIT0gbnVsbCAmJiBjdXJzb3IubW92ZVRvRmlyc3QoKSkge1xuICAgICAgICAgICAgICAgIGxldCBjb2x1bW5faW5kZXggPSBjdXJzb3IuZ2V0Q29sdW1uSW5kZXhPclRocm93KGNvbHVtbnNbMF0pO1xuICAgICAgICAgICAgICAgIGZpbGVQYXRoID0gY3Vyc29yLmdldFN0cmluZyhjb2x1bW5faW5kZXgpO1xuICAgICAgICAgICAgICAgIGlmIChmaWxlUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlsZVBhdGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgfVxuICAgICAgICBmaW5hbGx5IHtcbiAgICAgICAgICAgIGlmIChjdXJzb3IpIHtcbiAgICAgICAgICAgICAgICBjdXJzb3IuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgaXNFeHRlcm5hbFN0b3JhZ2VEb2N1bWVudCh1cmk6IGFuZHJvaWQubmV0LlVyaSkge1xuICAgICAgICByZXR1cm4gXCJjb20uYW5kcm9pZC5leHRlcm5hbHN0b3JhZ2UuZG9jdW1lbnRzXCIgPT09IHVyaS5nZXRBdXRob3JpdHkoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBpc0Rvd25sb2Fkc0RvY3VtZW50KHVyaTogYW5kcm9pZC5uZXQuVXJpKSB7XG4gICAgICAgIHJldHVybiBcImNvbS5hbmRyb2lkLnByb3ZpZGVycy5kb3dubG9hZHMuZG9jdW1lbnRzXCIgPT09IHVyaS5nZXRBdXRob3JpdHkoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBpc01lZGlhRG9jdW1lbnQodXJpOiBhbmRyb2lkLm5ldC5VcmkpIHtcbiAgICAgICAgcmV0dXJuIFwiY29tLmFuZHJvaWQucHJvdmlkZXJzLm1lZGlhLmRvY3VtZW50c1wiID09PSB1cmkuZ2V0QXV0aG9yaXR5KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0Q29udGVudFJlc29sdmVyKCk6IGFuZHJvaWQuY29udGVudC5Db250ZW50UmVzb2x2ZXIge1xuICAgICAgICByZXR1cm4gYXBwbGljYXRpb24uYW5kcm9pZC5uYXRpdmVBcHAuZ2V0Q29udGVudFJlc29sdmVyKCk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW1hZ2VQaWNrZXIge1xuICAgIHByaXZhdGUgX29wdGlvbnM7XG5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICAgIH1cblxuICAgIGdldCBtb2RlKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9vcHRpb25zICYmIHRoaXMuX29wdGlvbnMubW9kZSAmJiB0aGlzLl9vcHRpb25zLm1vZGUudG9Mb3dlckNhc2UoKSA9PT0gJ3NpbmdsZScgPyAnc2luZ2xlJyA6ICdtdWx0aXBsZSc7XG4gICAgfVxuXG4gICAgYXV0aG9yaXplKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoKDxhbnk+YW5kcm9pZCkub3MuQnVpbGQuVkVSU0lPTi5TREtfSU5UID49IDIzKSB7XG4gICAgICAgICAgICByZXR1cm4gcGVybWlzc2lvbnMucmVxdWVzdFBlcm1pc3Npb24oWyg8YW55PmFuZHJvaWQpLk1hbmlmZXN0LnBlcm1pc3Npb24uUkVBRF9FWFRFUk5BTF9TVE9SQUdFXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcmVzZW50KCk6IFByb21pc2U8aW1hZ2VBc3NldE1vZHVsZS5JbWFnZUFzc2V0W10+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgLy8gV0FSTklORzogSWYgd2Ugd2FudCB0byBzdXBwb3J0IG11bHRpcGxlIHBpY2tlcnMgd2Ugd2lsbCBuZWVkIHRvIGhhdmUgYSByYW5nZSBvZiBJRHMgaGVyZTpcbiAgICAgICAgICAgIGxldCBSRVNVTFRfQ09ERV9QSUNLRVJfSU1BR0VTID0gMTtcblxuICAgICAgICAgICAgbGV0IGFwcGxpY2F0aW9uID0gcmVxdWlyZShcImFwcGxpY2F0aW9uXCIpO1xuICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5vbihhcHBsaWNhdGlvbi5BbmRyb2lkQXBwbGljYXRpb24uYWN0aXZpdHlSZXN1bHRFdmVudCwgb25SZXN1bHQpO1xuXG5cblxuXG4gICAgICAgICAgICBmdW5jdGlvbiBvblJlc3VsdChhcmdzKSB7XG5cbiAgICAgICAgICAgICAgICBsZXQgcmVxdWVzdENvZGUgPSBhcmdzLnJlcXVlc3RDb2RlO1xuICAgICAgICAgICAgICAgIGxldCByZXN1bHRDb2RlID0gYXJncy5yZXN1bHRDb2RlO1xuICAgICAgICAgICAgICAgIGxldCBkYXRhID0gYXJncy5pbnRlbnQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRDb2RlID09PSBhbmRyb2lkLmFwcC5BY3Rpdml0eS5SRVNVTFRfT0spIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0cyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNsaXAgPSBkYXRhLmdldENsaXBEYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNvdW50ID0gY2xpcC5nZXRJdGVtQ291bnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgY2xpcEl0ZW0gPSBjbGlwLmdldEl0ZW1BdChpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGlwSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB1cmkgPSBjbGlwSXRlbS5nZXRVcmkoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXJpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzZWxlY3RlZEFzc2V0ID0gbmV3IGltYWdlQXNzZXRNb2R1bGUuSW1hZ2VBc3NldChVcmlIZWxwZXIuX2NhbGN1bGF0ZUZpbGVVcmkodXJpKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChzZWxlY3RlZEFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdXJpID0gZGF0YS5nZXREYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXMgPSBVcmlIZWxwZXIuX2NhbGN1bGF0ZUZpbGVVcmkodXJpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNlbGVjdGVkQXNzZXQgPSBuZXcgaW1hZ2VBc3NldE1vZHVsZS5JbWFnZUFzc2V0KHJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlID0gLyg/OlxcLihbXi5dKykpPyQvO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZXh0ID0gcmUuZXhlYyhyZXMpWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbGlzdEV4dGVuc2lvbnMgPSBbXCJwZGZcIiwgXCJkb2NcIiwgXCJkb2N4XCIsIFwib2R0XCIsIFwicnRmXCIsIFwianBnXCIsIFwianBlZ1wiLCBcInBuZ1wiXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBleHQgIT09IHVuZGVmaW5lZCAmJiAobGlzdEV4dGVuc2lvbnMuaW5kZXhPZihleHQpID4gLTEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goc2VsZWN0ZWRBc3NldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbi5hbmRyb2lkLm9mZihhcHBsaWNhdGlvbi5BbmRyb2lkQXBwbGljYXRpb24uYWN0aXZpdHlSZXN1bHRFdmVudCwgb25SZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5vZmYoYXBwbGljYXRpb24uQW5kcm9pZEFwcGxpY2F0aW9uLmFjdGl2aXR5UmVzdWx0RXZlbnQsIG9uUmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbi5hbmRyb2lkLm9mZihhcHBsaWNhdGlvbi5BbmRyb2lkQXBwbGljYXRpb24uYWN0aXZpdHlSZXN1bHRFdmVudCwgb25SZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcIkltYWdlIHBpY2tlciBhY3Rpdml0eSByZXN1bHQgY29kZSBcIiArIHJlc3VsdENvZGUpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgSW50ZW50ID0gYW5kcm9pZC5jb250ZW50LkludGVudDtcbiAgICAgICAgICAgIGxldCBpbnRlbnQgPSBuZXcgSW50ZW50KCk7XG4gICAgICAgICAgICBpbnRlbnQuc2V0VHlwZShcIiovKlwiKTtcblxuICAgICAgICAgICAgLy8gVE9ETzogVXNlICg8YW55PmFuZHJvaWQpLmNvbnRlbnQuSW50ZW50LkVYVFJBX0FMTE9XX01VTFRJUExFXG4gICAgICAgICAgICBpZiAodGhpcy5tb2RlID09PSAnbXVsdGlwbGUnKSB7XG4gICAgICAgICAgICAgICAgaW50ZW50LnB1dEV4dHJhKFwiYW5kcm9pZC5pbnRlbnQuZXh0cmEuQUxMT1dfTVVMVElQTEVcIiwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGludGVudC5zZXRBY3Rpb24oSW50ZW50LkFDVElPTl9HRVRfQ09OVEVOVCk7XG5cbiAgICAgICAgICAgIGxldCBjaG9vc2VyID0gSW50ZW50LmNyZWF0ZUNob29zZXIoaW50ZW50LCBcIlNlbGVjdCBQaWN0dXJlXCIpO1xuICAgICAgICAgICAgYXBwbGljYXRpb24uYW5kcm9pZC5mb3JlZ3JvdW5kQWN0aXZpdHkuc3RhcnRBY3Rpdml0eUZvclJlc3VsdChpbnRlbnQsIFJFU1VMVF9DT0RFX1BJQ0tFUl9JTUFHRVMpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGUob3B0aW9ucz8pOiBJbWFnZVBpY2tlciB7XG4gICAgcmV0dXJuIG5ldyBJbWFnZVBpY2tlcihvcHRpb25zKTtcbn1cbiJdfQ==